#!/usr/bin/env bash

# identify-recurring-thought-patterns - Identify recurring patterns in thought events (declarative version)

set -euo pipefail

# Source configuration and modular libraries
source "${0%/*}/../../.ks-env"
source "$KS_ROOT/lib/core.sh"
source "$KS_ROOT/lib/files.sh"
source "$KS_ROOT/lib/time.sh"
source "$KS_ROOT/lib/argparse.sh"
source "$KS_ROOT/tools/lib/queue.sh"
source "$KS_ROOT/tools/lib/claude.sh"

# Define command description
ks_define_usage "Identify recurring patterns in thought events using AI analysis"

# Check for background analysis results
ks_check_background_results || true

# Initialize and define options
ks_init_options
ks_example "--days 30"
ks_example "--since 2024-01-01 --format markdown"
ks_option "days" "d" "Analyze events from last N days" "30" "ks_handle_days"
ks_option "since" "s" "Analyze events since ISO date (overrides --days)" "" "ks_handle_since"
ks_option "format" "f" "Output format: text, json, markdown" "text" "ks_handle_format"

# Process options - this sets DAYS, SINCE, FORMAT variables
ks_process_options "$@"

# Extract only thought events
CONTENT=$(ks_extract_events "$DAYS" "$SINCE" ".type == \"thought\"")

[[ -z "$CONTENT" ]] && { echo "No thought events found in the last $DAYS days"; exit 0; }

# Prepare AI prompt
PROMPT="Analyze the following thought events from the last $DAYS days and identify recurring patterns.

$CONTENT

Look for:
1. Topics or themes that appear repeatedly
2. Patterns in how thoughts develop or evolve
3. Common triggers or contexts
4. Recurring questions or concerns

Return ONLY valid JSON in this format:
{
  \"patterns\": [
    {
      \"pattern\": \"Pattern description\",
      \"frequency\": \"How often it appears\",
      \"examples\": [\"example1\", \"example2\"],
      \"significance\": \"Why this pattern matters\"
    }
  ]
}

If no patterns are found, return: {\"patterns\": []}"

# Analyze with Claude
ANALYSIS=$(ks_claude_analyze "$PROMPT" || echo "Error: Analysis failed")

# Output based on format
ks_format_analysis "$ANALYSIS" "$FORMAT" "Thought Pattern Analysis"