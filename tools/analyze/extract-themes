#!/usr/bin/env bash

# extract-themes - Extract key themes from knowledge events
# Usage: extract-themes [--days N] [--type TYPE]

set -euo pipefail

# Source configuration
source "$(dirname "$0")/../../.ks-env"

# Default values
DAYS="${1:-7}"
TYPE_FILTER=""
FORMAT="text"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --days)
            DAYS="$2"
            shift 2
            ;;
        --type)
            TYPE_FILTER="$2"
            shift 2
            ;;
        --format)
            FORMAT="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: extract-themes [options]"
            echo ""
            echo "Options:"
            echo "  --days N        Analyze events from last N days (default: 7)"
            echo "  --type TYPE     Filter by event type"
            echo "  --format FORMAT Output format: text, json, markdown (default: text)"
            echo ""
            echo "Extract key themes from knowledge events using AI analysis"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Build filter
FILTER="."
if [ -n "$TYPE_FILTER" ]; then
    FILTER="$FILTER | select(.type == \"$TYPE_FILTER\")"
fi

# Validate --days parameter
ks_validate_days "$DAYS" || exit 1

# Calculate date range
SINCE_DATE=$(date -u -d "${DAYS} days ago" +%Y-%m-%dT%H:%M:%SZ)

# Collect events from hot log and archives using shared function
CONTENT=""

# Use shared file collection function
ks_collect_files

# Process all files in single jq call if any files exist
if [ ${#FILES_TO_PROCESS[@]} -gt 0 ]; then
    CONTENT=$(cat "${FILES_TO_PROCESS[@]}" | jq -r --arg since_date "$SINCE_DATE" "$FILTER | select(.ts >= \$since_date) | .content" 2>/dev/null | grep -v '^$' || true)
fi

if [ -z "$CONTENT" ]; then
    echo "No events found in the last $DAYS days"
    exit 0
fi

# Get analysis from Claude using wrapper function
ANALYSIS=$(echo "$CONTENT" | ks_claude --model "$KS_MODEL" --print --output-format json "Extract 3-5 key themes from these thoughts. Return JSON: {themes: [{name: string, description: string, frequency: number, supporting_quotes: [string]}]}")

# Clean up any markdown code blocks if present
if echo "$ANALYSIS" | grep -q '```json'; then
    ANALYSIS=$(echo "$ANALYSIS" | sed -n '/```json/,/```/p' | sed '1d;$d')
fi

# Format output based on requested format
case "$FORMAT" in
    json)
        echo "$ANALYSIS"
        ;;
    markdown)
        echo "# Knowledge Themes Analysis"
        echo ""
        echo "_Analysis of events from the last ${DAYS} days_"
        echo ""
        echo "$ANALYSIS" | jq -r '.themes[] | "## \(.name)\n\n\(.description)\n\n**Frequency:** \(.frequency)\n\n### Supporting Evidence:\n\(.supporting_quotes | map("- \"\(.)\"") | join("\n"))\n"'
        ;;
    text|*)
        echo "=== KNOWLEDGE THEMES ANALYSIS ==="
        echo "Events from last $DAYS days"
        echo ""
        echo "$ANALYSIS" | jq -r '.themes[] | "THEME: \(.name)\n\(.description)\nFrequency: \(.frequency)\nEvidence:\n\(.supporting_quotes | map("  - \"\(.)\"") | join("\n"))\n"'
        ;;
esac