#!/usr/bin/env bash

# query - Search and filter knowledge events (declarative version)

set -euo pipefail

# Source configuration and modular libraries
source "${0%/*}/../../.ks-env"
source "$KS_ROOT/lib/core.sh"
source "$KS_ROOT/lib/files.sh"
source "$KS_ROOT/lib/time.sh"
source "$KS_ROOT/lib/argparse.sh"

# Define command description
ks_define_usage "Search and filter knowledge events

Usage: query [options] [search_term]

Examples:
  query memory                  # Search for 'memory' in all events
  query --days 7 \"learning\"     # Search last 7 days for 'learning'
  query --type thought --count  # Count all thought events"

# Initialize and define options
ks_init_options
ks_example "memory"
ks_example "--days 7 \"learning\""
ks_option "days" "d" "Search events from last N days" "" "ks_handle_days"
ks_option "since" "s" "Search events since ISO date" "" "ks_handle_since"
ks_option "type" "t" "Filter by event type" "" ""
ks_option "topic" "p" "Filter by topic metadata" "" ""
ks_option "limit" "l" "Limit number of results" "20" ""
ks_option "reverse" "r" "Show oldest events first" "" "" "flag"
ks_option "count" "c" "Show only count of matching events" "" "" "flag"

# Process options - this captures remaining args in global array
REMAINING_ARGS=()
ks_process_options "$@"

# Get the search term from remaining arguments
SEARCH_TERM="${REMAINING_ARGS[0]:-}"

# Get filter date
FILTER_DATE=$(ks_get_filter_date "$DAYS" "$SINCE")

# Collect files
ks_collect_files_since "$FILTER_DATE"

[[ ${#FILES_TO_PROCESS[@]} -eq 0 ]] && { echo "No events found"; exit 0; }

# Build the jq filter
FILTER=".ts >= \"$FILTER_DATE\""

# Add filters
[[ -n "$TYPE" ]] && FILTER="$FILTER and .type == \"$TYPE\""
[[ -n "$TOPIC" ]] && FILTER="$FILTER and .metadata.topic == \"$TOPIC\""
[[ -n "$SEARCH_TERM" ]] && FILTER="$FILTER and (tostring | test(\"$SEARCH_TERM\"; \"i\"))"

# Prepare for counting or normal output
COUNT_FLAG=""
[[ "$COUNT" == "true" ]] && COUNT_FLAG="-s"

# Build sort option
SORT_CMD="sort -n"
[[ "$REVERSE" == "true" ]] && SORT_CMD="sort -nr"

# Process files
{
    for file in "${FILES_TO_PROCESS[@]}"; do
        if [[ -f "$file" && -s "$file" ]]; then
            jq $COUNT_FLAG -r "select($FILTER) | \"\\(.ts // \"unknown\"): \\(.type // \"unknown\") - \\(.thought // .observation // .question // .content // \"empty\")\"" "$file" 2>/dev/null || true
        fi
    done
} | if [[ "$COUNT" == "true" ]]; then
    # Count mode
    wc -l | tr -d ' '
else
    # Normal mode
    $SORT_CMD | head -n "$LIMIT"
fi